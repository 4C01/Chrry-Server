openapi: 3.0.3
info:
  title: Chrry-Server API
  description: 定制AI小助手服务端API
  version: v1
  contact:
    name: API支持
    url: https://github.com/4C01/Chrry-Server

servers:
  - url: http://localhost:5000
    description: 本地开发服务器

security:
  - ApiKeyAuth: []

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: 用于身份验证的API密钥

  schemas:
    SuccessResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          description: 响应数据
          nullable: true

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        cause:
          type: string
          description: 错误原因

    Prompt:
      type: object
      properties:
        name:
          type: string
          description: 提示词标识符
        value:
          type: string
          description: 提示词内容

    AIConfig:
      type: object
      properties:
        name:
          type: string
          description: AI配置名称
        provider:
          type: string
          enum: [openai, deepseek, ollama, siliconflow]
          description: 服务提供商
        model:
          type: string
          description: 模型名称
        api_key:
          type: string
          description: API密钥
        base_url:
          type: string
          description: API基础URL
        temperature:
          type: number
          minimum: 0
          maximum: 2
          default: 0.7
        max_tokens:
          type: integer
          default: 1024
        timeout:
          type: integer
          default: 30
          description: 请求超时时间（秒）

    ChatConversation:
      type: object
      properties:
        conversation_id:
          type: string
          description: 对话唯一标识符
        name:
          type: string
          description: 对话名称
        prompt:
          type: string
          description: 使用的提示词类型
        ai:
          type: string
          description: AI配置UUID
        device:
          type: string
          description: 设备标识符
        created:
          type: integer
          description: 创建时间戳
        updated:
          type: integer
          description: 最后更新时间戳
        message_count:
          type: integer
          description: 消息数量

    ChatMessage:
      type: object
      properties:
        role:
          type: string
          enum: [user, assistant, system, tool]
          description: 消息发送者角色
        content:
          type: string
          description: 消息内容
        timestamp:
          type: integer
          description: 消息时间戳
        tool_calls:
          type: array
          items:
            type: object
          description: 工具调用列表（仅assistant角色）
        tool_call_id:
          type: string
          description: 工具调用ID（仅tool角色）
        finish_reason:
          type: string
          description: 完成原因（仅assistant角色）
        usage:
          type: object
          properties:
            total_tokens:
              type: integer
              description: 总token数

    AIResponse:
      type: object
      properties:
        message:
          type: string
          description: AI回复的文本内容
        tools:
          type: array
          items:
            type: object
          description: 工具调用列表
        reason:
          type: string
          description: 完成原因
        tokens:
          type: integer
          description: 使用的token数量

paths:
  # AI配置管理
  /v1/ai/list:
    get:
      summary: 列出所有AI配置
      description: 获取系统中配置的所有AI模型和服务
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
                example:
                  success: true
                  data:
                    test-ai-001:
                      name: 测试AI
                      provider: deepseek
                      model: deepseek-chat
                      api_key: sk-*****
                      base_url: https://api.deepseek.com
                      temperature: 0.7
                      max_tokens: 1024
                      timeout: 30
        '403':
          description: API密钥无效
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 服务器内部错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v1/ai/get:
    get:
      summary: 获取单个AI配置
      description: 通过UUID获取特定的AI配置
      parameters:
        - name: uuid
          in: query
          required: true
          schema:
            type: string
          description: AI配置的UUID
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
                example:
                  success: true
                  data:
                    name: 测试AI
                    provider: deepseek
                    model: deepseek-chat
                    api_key: sk-*****
                    base_url: https://api.deepseek.com
                    temperature: 0.7
                    max_tokens: 1024
                    timeout: 30
        '400':
          description: 缺少UUID参数
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: API密钥无效
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: AI配置不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 服务器内部错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v1/ai/set:
    post:
      summary: 设置或更新AI配置
      description: 创建新的AI配置或更新已存在的配置
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [uuid, config]
              properties:
                uuid:
                  type: string
                  description: AI配置的唯一标识符
                config:
                  $ref: '#/components/schemas/AIConfig'
      responses:
        '200':
          description: 设置成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
                example:
                  success: true
                  data:
                    message: AI配置设置成功
                    uuid: test-ai-001
        '400':
          description: 请求参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: API密钥无效
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 服务器内部错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # 提示词管理
  /v1/prompt/set:
    post:
      summary: 创建或更新提示词
      description: 创建新的提示词或更新已存在的提示词
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, value]
              properties:
                name:
                  type: string
                  description: 提示词标识符
                value:
                  type: string
                  description: 提示词内容
      responses:
        '200':
          description: 设置成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
                example:
                  success: true
                  data:
                    message: 提示词设置成功
                    name: common
        '400':
          description: 请求错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: API密钥无效
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: 参数格式错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 服务器内部错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v1/prompt/get:
    get:
      summary: 通过名称获取提示词
      description: 获取特定的提示词
      parameters:
        - name: name
          in: query
          required: true
          schema:
            type: string
          description: 提示词名称
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
                example:
                  success: true
                  data:
                    name: common
                    value: "你是一个乐于助人的AI助手，请以友好、专业的方式回答用户的问题。"
        '400':
          description: 请求错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: API密钥无效
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: 提示词不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 服务器内部错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v1/prompt/list:
    get:
      summary: 列出所有提示词
      description: 获取所有提示词
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
                example:
                  success: true
                  data:
                    common: "你是一个乐于助人的AI助手，请以友好、专业的方式回答用户的问题。"
                    coding: "你是一个专业的程序员，擅长编写各种代码。"
        '403':
          description: API密钥无效
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 服务器内部错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # 对话管理
  /v1/create:
    post:
      summary: 创建新的聊天会话
      description: 使用AI模型和提示词创建新的聊天会话
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, prompt, ai, device]
              properties:
                name:
                  type: string
                  description: 聊天会话名称
                prompt:
                  type: string
                  description: 提示词名称
                ai:
                  type: string
                  description: AI配置UUID
                device:
                  type: string
                  description: 设备标识符
      responses:
        '200':
          description: 创建成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
                example:
                  success: true
                  data:
                    conversation_id: "2df822a2-9002-47fc-be9b-eccf6547388c"
                    name: "测试对话"
                    message: "对话创建成功"
        '400':
          description: 请求错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: API密钥无效
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: AI或提示词不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 服务器内部错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v1/chat/send:
    post:
      summary: 发送聊天消息
      description: 在聊天会话中发送消息
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [conversation, device, message]
              properties:
                conversation:
                  type: string
                  description: 聊天会话UUID
                device:
                  type: string
                  description: 设备标识符
                message:
                  type: string
                  description: 消息内容
                tool_response:
                  type: object
                  description: 工具执行结果
                tools:
                  type: array
                  description: 可用工具列表
      responses:
        '200':
          description: AI响应
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
                example:
                  success: true
                  data:
                    message: "你好！我是AI助手，有什么可以帮助你的吗？"
                    tools: []
                    reason: "stop"
                    tokens: 42
        '400':
          description: 请求错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: API密钥无效
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: 聊天会话不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 服务器内部错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v1/chat/list:
    get:
      summary: 列出所有聊天会话
      description: 获取所有聊天会话，可选按设备筛选
      parameters:
        - name: device
          in: query
          required: false
          schema:
            type: string
          description: 设备标识符，用于筛选对话
      responses:
        '200':
          description: 成功响应
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
                example:
                  success: true
                  data:
                    "2df822a2-9002-47fc-be9b-eccf6547388c":
                      name: "测试对话"
                      prompt: "common"
                      ai: "test-ai-001"
                      device: "test_device_001"
                      created: 1741589723
                      updated: 1741589823
                      message_count: 10
        '403':
          description: API密钥无效
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 服务器内部错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # 历史记录管理
  /v1/history/get:
    get:
      summary: 获取聊天历史
      description: 获取聊天历史记录，支持压缩和分页选项
      parameters:
        - name: uuid
          in: query
          required: true
          schema:
            type: string
          description: 聊天会话UUID
        - name: tactical
          in: query
          schema:
            type: boolean
            default: false
          description: 是否只返回压缩后的历史记录
        - name: lines
          in: query
          schema:
            type: integer
          description: 返回的行数
      responses:
        '200':
          description: 聊天历史
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
                examples:
                  tactical:
                    summary: 只返回tactical历史
                    value:
                      success: true
                      data:
                        tactical:
                          - role: user
                            content: "你好"
                            timestamp: 1741589723
                          - role: assistant
                            content: "你好！有什么可以帮助你的吗？"
                            timestamp: 1741589725
                        message_count: 2
                  full:
                    summary: 返回完整历史
                    value:
                      success: true
                      data:
                        metadata:
                          name: "测试对话"
                          prompt: "common"
                          ai: "test-ai-001"
                          interval: 8
                          device: "test_device_001"
                          created: 1741589723
                          updated: 1741589823
                          message_count: 10
                        tactical:
                          - role: user
                            content: "最近的消息"
                            timestamp: 1741589820
                          - role: assistant
                            content: "这是回复"
                            timestamp: 1741589823
                        archive:
                          - type: compressed
                            content: "用户询问了天气情况，AI提供了天气信息"
                            original_count: 8
                            timestamp: 1741589800
                        raw_context: []
        '400':
          description: 请求错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: API密钥无效
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: 聊天会话不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 服务器内部错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v1/history/memory:
    get:
      summary: 获取记忆列表
      description: 获取聊天会话的压缩记忆列表
      parameters:
        - name: uuid
          in: query
          required: true
          schema:
            type: string
          description: 聊天会话UUID
      responses:
        '200':
          description: 记忆列表
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
                example:
                  success: true
                  data:
                    memories:
                      - "用户询问了天气情况，AI提供了天气信息"
                      - "用户询问了时间，AI提供了当前时间"
                    count: 2
        '400':
          description: 请求错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: API密钥无效
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: 聊天会话不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 服务器内部错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # 健康检查
  /health:
    get:
      summary: 健康检查
      description: 检查API服务是否正常运行
      responses:
        '200':
          description: 服务正常
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: healthy
                  timestamp:
                    type: number
                    example: 1741589723
                  version:
                    type: string
                    example: v1.0.0